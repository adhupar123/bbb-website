<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulator — BBB Diffusion (Simple)</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* quick overrides for simulator */
    .simcard{padding:12px}
    #simCanvas{width:100%;height:420px;border-radius:10px;background:#fff;border:1px solid #e6edf8; display:block}
    label{font-weight:600;display:block;margin-top:10px}
    .small{font-size:13px;color:#6b7280}
    .controls{max-width:420px}
  </style>
</head>
<body>
  <header class="navwrap"><div class="container topbar"><div class="brand"><h1>Interactive Simulator</h1><div class="muted">Simple visual model</div></div>
  <nav class="mainnav"><a href="index.html">Home</a></nav></div></header>

  <main class="container">
    <section class="card simcard">
      <h2>BBB Diffusion — Simple Visualizer</h2>
      <p class="small">Three controls: <strong>radius</strong>, <strong>LogBB</strong>, and <strong>charge</strong>. Particles that successfully cross will flow into the brain region (to the right) and be counted when they exit the canvas.</p>

      <canvas id="simCanvas"></canvas>

      <div style="display:flex;gap:20px;margin-top:12px;flex-wrap:wrap">
        <div class="controls">
          <label>Particle radius (nm): <span id="radLabel">40</span></label>
          <input id="radSlider" type="range" min="5" max="150" value="40">

          <label>LogBB value: <span id="logbbLabel">-1.0</span></label>
          <input id="logbb" type="range" min="-1.5" max="1.0" step="0.1" value="-1.0">

          <label>Charge</label>
          <select id="charge">
            <option value="neutral">Neutral</option>
            <option value="positive">Positive</option>
            <option value="negative">Negative</option>
          </select>

          <div style="margin-top:10px">
            <a id="startBtn" class="btn">Start</a>
            <a id="resetBtn" class="btn ghost">Reset</a>
          </div>

          <p class="small">Flowed across BBB: <span id="crossed">0</span> / <span id="total">0</span></p>
        </div>
      </div>
    </section>
  </main>

<script>
// Modified simulator: successful crossing makes particles flow into the brain region
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

// Fit canvas to displayed size (pixel ratio)
function fitCanvas(){
  const DPR = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

const NUM = 400;       // fixed particle count
const FIXED_D = 5;     // fixed diffusion coefficient (visual)
const FIXED_PERM = 0.06; // base permeability

let particles = [];
let running = false;
let crossed = 0;

// UI elements
const radSlider = document.getElementById('radSlider');
const radLabel = document.getElementById('radLabel');
const logbb = document.getElementById('logbb');
const logbbLabel = document.getElementById('logbbLabel');
const charge = document.getElementById('charge');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const crossedEl = document.getElementById('crossed');
const totalEl = document.getElementById('total');

radSlider.oninput = e => radLabel.textContent = e.target.value;
logbb.oninput = e => logbbLabel.textContent = e.target.value;

function rand(a,b){return a + Math.random()*(b-a);} 

function init(){
  particles = [];
  crossed = 0;
  const rpx = Math.max(2, Number(radSlider.value) / 20);
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  for(let i=0;i<NUM;i++){ 
    particles.push({
      x: rand(8, w/2 - 30),
      y: rand(8, h - 8),
      r: rpx,
      passed: false,   // has been allowed to flow through the barrier
      removed: false,  // counted and removed from view
      vx: 0
    });
  }
  crossedEl.textContent = crossed;
  totalEl.textContent = NUM;
}

function drawBackground(){
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,w,h);
  // barrier line
  ctx.fillStyle = '#0b5fff';
  ctx.fillRect(w/2 - 3, 0, 6, h);
  // labels
  ctx.fillStyle = '#223';
  ctx.font = '12px system-ui, Arial';
  ctx.fillText('Bloodstream', 10, 16);
  ctx.fillText('Brain', w - 60, 16);
}

function step(dt){
  const rnm = Number(radSlider.value);
  const logbbVal = Number(logbb.value);
  const chargeMode = charge.value;

  const w = canvas.clientWidth, h = canvas.clientHeight;
  const bx = w/2;

  // map logBB -1.5..1.0 -> 0..1
  const t = Math.min(1, Math.max(0, (logbbVal + 1.5) / 2.5));
  const logbbEffect = 0.4 * t + 0.6; // 0.6..1.0
  const sizeFactor = Math.max(0.05, 1 - (rnm / 200));

  for(const p of particles){
    if(p.removed) continue;

    if(!p.passed){
      // diffusion
      p.x += rand(-1,1) * FIXED_D * dt * 18;
      p.y += rand(-1,1) * FIXED_D * dt * 18;

      // small charge bias
      if(chargeMode === 'positive') p.x += 0.4;
      if(chargeMode === 'negative') p.x -= 0.4;

      // bounds
      if(p.y < p.r + 4) p.y = p.r + 4;
      if(p.y > h - (p.r + 4)) p.y = h - (p.r + 4);

      // interaction with barrier
      if(p.x > bx - (p.r + 2)){ 
        const prob = FIXED_PERM * logbbEffect * sizeFactor;
        if(Math.random() < prob){
          // allowed to pass -> give a rightward velocity so the particle flows across
          p.passed = true;
          // velocity (pixels per second) — depends on logBB and size
          const baseSpeed = 30 + 40 * t; // 30..70
          p.vx = baseSpeed * (0.5 + Math.random()*1.0) * (0.6 + sizeFactor);
          // slight upward/downward kick so they don't all travel in a line
          p.vy = rand(-10,10);
        } else {
          // bounce back slightly to the left of the barrier
          p.x = bx - (p.r + 6);
        }
      }
    } else {
      // flowing through the barrier into the brain region
      // continue to the right with vx, add small vertical drift
      p.x += p.vx * dt;
      p.y += (p.vy || 0) * dt * 0.5;

      // gentle diffusion inside brain
      p.x += rand(-0.2,0.2) * FIXED_D * dt * 18;
      p.y += rand(-0.4,0.4) * FIXED_D * dt * 18;

      // count and mark removed once they exit the canvas to the right
      if(p.x > w - (p.r + 4)){
        p.removed = true;
        crossed++;
      }

      // keep vertically in bounds
      if(p.y < p.r + 4) p.y = p.r + 4;
      if(p.y > h - (p.r + 4)) p.y = h - (p.r + 4);
    }
  }
  crossedEl.textContent = crossed;
}

function render(){
  drawBackground();
  for(const p of particles){
    if(p.removed) continue;
    // color by logBB for non-passed; passed particles are shown green
    const t = Math.min(1, Math.max(0, (Number(logbb.value) + 1.5) / 2.5));
    const r = Math.round(220 * t + 10 * (1 - t));
    const b = Math.round(220 * (1 - t) + 10 * t);
    ctx.beginPath();
    if(p.passed){
      ctx.fillStyle = 'rgba(34,197,94,0.95)'; // green for flowing particles
    } else {
      ctx.fillStyle = `rgb(${r},80,${b})`;
    }
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }
}

let lastTime = null;
function loop(now){
  if(!running) return;
  if(!lastTime) lastTime = now;
  const dt = Math.min(0.05, (now - lastTime)/1000);
  lastTime = now;
  step(dt);
  render();
  requestAnimationFrame(loop);
}

startBtn.addEventListener('click', ()=>{
  if(!running){
    running = true;
    lastTime = null;
    requestAnimationFrame(loop);
  }
});
resetBtn.addEventListener('click', ()=>{
  running = false;
  init();
  render();
});

init();
render();
</script>
</body>
</html>
