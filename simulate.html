<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulator — BBB Diffusion (Simple)</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .simcard{padding:12px}
    #simCanvas{width:100%;height:420px;border-radius:10px;background:#fff;border:1px solid #e6edf8; display:block}
    label{font-weight:600;display:block;margin-top:10px}
    .small{font-size:13px;color:#6b7280}
    .controls{max-width:420px}
  </style>
</head>
<body>
  <header class="navwrap"><div class="container topbar"><div class="brand"><h1>Interactive Simulator</h1><div class="muted">Simple visual model with equilibrium</div></div>
  <nav class="mainnav"><a href="index.html">Home</a></nav></div></header>

  <main class="container">
    <section class="card simcard">
      <h2>BBB Diffusion — Equilibrium Visualizer</h2>
      <p class="small">Adjust <strong>radius</strong> and <strong>LogBB</strong> to see how they affect equilibrium distribution. Particles randomly diffuse and cross the barrier based on their properties.</p>

      <canvas id="simCanvas"></canvas>

      <div style="display:flex;gap:20px;margin-top:12px;flex-wrap:wrap">
        <div class="controls">
          <label>Particle radius (nm): <span id="radLabel">40</span></label>
          <input id="radSlider" type="range" min="5" max="150" value="40">

          <label>LogBB value: <span id="logbbLabel">-1.0</span></label>
          <input id="logbb" type="range" min="-1.5" max="1.0" step="0.1" value="-1.0">

          <div style="margin-top:10px">
            <a id="startBtn" class="btn">Start</a>
            <a id="resetBtn" class="btn ghost">Reset</a>
          </div>

          <p class="small">Bloodstream: <span id="bloodCount">400</span> | Brain: <span id="brainCount">0</span></p>
        </div>
      </div>
    </section>
  </main>

<script>
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

function fitCanvas(){
  const DPR = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

const NUM = 400;
const FIXED_D = 5;
const FIXED_PERM = 0.06;

let particles = [];
let running = false;

const radSlider = document.getElementById('radSlider');
const radLabel = document.getElementById('radLabel');
const logbb = document.getElementById('logbb');
const logbbLabel = document.getElementById('logbbLabel');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const bloodCountEl = document.getElementById('bloodCount');
const brainCountEl = document.getElementById('brainCount');

radSlider.oninput = e => radLabel.textContent = e.target.value;
logbb.oninput = e => logbbLabel.textContent = e.target.value;

function rand(a,b){return a + Math.random()*(b-a);} 

function init(){
  particles = [];
  const rpx = Math.max(2, Number(radSlider.value) / 20);
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  
  // All particles start in bloodstream (left side)
  for(let i=0;i<NUM;i++){ 
    particles.push({
      x: rand(rpx + 8, w/2 - 30),
      y: rand(rpx + 8, h - rpx - 8),
      r: rpx,
      vx: rand(-20, 20),  // random velocity
      vy: rand(-20, 20),
      justCrossed: false
    });
  }
  updateCounts();
}

function updateCounts(){
  const w = canvas.clientWidth;
  const bx = w/2;
  
  let inBrain = 0;
  let inBlood = 0;
  
  for(const p of particles){
    if(p.x > bx){
      inBrain++;
    } else {
      inBlood++;
    }
  }
  
  bloodCountEl.textContent = inBlood;
  brainCountEl.textContent = inBrain;
}

function drawBackground(){
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,w,h);
  
  // barrier line
  ctx.fillStyle = '#0b5fff';
  ctx.fillRect(w/2 - 3, 0, 6, h);
  
  // labels
  ctx.fillStyle = '#223';
  ctx.font = '12px system-ui, Arial';
  ctx.fillText('Bloodstream', 10, 16);
  ctx.fillText('Brain', w - 60, 16);
}

function step(dt){
  const rnm = Number(radSlider.value);
  const logbbVal = Number(logbb.value);

  const w = canvas.clientWidth, h = canvas.clientHeight;
  const bx = w/2;

  // Calculate crossing probability factors
  const t = Math.min(1, Math.max(0, (logbbVal + 1.5) / 2.5));
  const logbbEffect = 0.2 * t + 0.8;
  const sizeFactor = Math.max(0.05, 1 - (rnm / 200));
  
  const baseCrossProb = FIXED_PERM * sizeFactor * 1.5;
  
  const bloodToBrainProb = baseCrossProb * logbbEffect;
  const brainToBloodProb = baseCrossProb * (2.2 - logbbEffect);

  for(const p of particles){
    const distToBarrier = Math.abs(p.x - bx);
    
    // Reset justCrossed flag if particle has moved away from barrier
    if(p.justCrossed && distToBarrier > p.r + 15){
      p.justCrossed = false;
    }

    // Brownian motion - random walk
    p.vx += rand(-30, 30) * dt;
    p.vy += rand(-30, 30) * dt;
    
    // Damping to keep velocities reasonable
    p.vx *= 0.95;
    p.vy *= 0.95;
    
    // Update position
    p.x += p.vx * dt;
    p.y += p.vy * dt;

    // Bounce off top and bottom walls
    if(p.y - p.r < 4){
      p.y = p.r + 4;
      p.vy = Math.abs(p.vy) * 0.8;
    }
    if(p.y + p.r > h - 4){
      p.y = h - p.r - 4;
      p.vy = -Math.abs(p.vy) * 0.8;
    }

    // Bounce off left and right walls
    if(p.x - p.r < 4){
      p.x = p.r + 4;
      p.vx = Math.abs(p.vx) * 0.8;
    }
    if(p.x + p.r > w - 4){
      p.x = w - p.r - 4;
      p.vx = -Math.abs(p.vx) * 0.8;
    }

    // Check for barrier interaction - only if not just crossed
    if(!p.justCrossed && distToBarrier < p.r + 3){
      const crossingToBrain = (p.x < bx);
      const crossProb = crossingToBrain ? bloodToBrainProb : brainToBloodProb;
      
      // Attempt crossing
      if(Math.random() < crossProb){
        // Successfully cross to the other side
        if(crossingToBrain){
          p.x = bx + p.r + 8;
        } else {
          p.x = bx - p.r - 8;
        }
        p.justCrossed = true;
        // Velocity continues in same direction
      } else {
        // Failed to cross - bounce back from barrier
        if(crossingToBrain){
          p.x = bx - p.r - 8;
          p.vx = -Math.abs(p.vx) * 0.8;
        } else {
          p.x = bx + p.r + 8;
          p.vx = Math.abs(p.vx) * 0.8;
        }
      }
    }
  }
  
  updateCounts();
}

function render(){
  drawBackground();
  
  const logbbVal = Number(logbb.value);
  const t = Math.min(1, Math.max(0, (logbbVal + 1.5) / 2.5));
  const w = canvas.clientWidth;
  const bx = w/2;
  
  for(const p of particles){
    ctx.beginPath();
    
    // Color based on which side of barrier
    if(p.x > bx){
      // In brain - green
      ctx.fillStyle = 'rgba(34,197,94,0.85)';
    } else {
      // In bloodstream - color gradient based on logBB
      const r = Math.round(220 * t + 10 * (1 - t));
      const b = Math.round(220 * (1 - t) + 10 * t);
      ctx.fillStyle = `rgb(${r},80,${b})`;
    }
    
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }
}

let lastTime = null;
function loop(now){
  if(!running) return;
  if(!lastTime) lastTime = now;
  const dt = Math.min(0.05, (now - lastTime)/1000);
  lastTime = now;
  step(dt);
  render();
  requestAnimationFrame(loop);
}

startBtn.addEventListener('click', ()=>{
  if(!running){
    running = true;
    lastTime = null;
    requestAnimationFrame(loop);
  }
});

resetBtn.addEventListener('click', ()=>{
  running = false;
  init();
  render();
});

init();
render();
</script>
</body>
</html>
